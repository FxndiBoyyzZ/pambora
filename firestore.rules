
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      // O e-mail do admin é pego do documento 'admin_user' na coleção 'config'.
      // Isso é mais seguro do que deixar o e-mail fixo nas regras.
      // A função `exists` garante que a leitura só aconteça se o documento existir.
      return exists(/databases/$(database)/documents/config/admin_user) &&
             request.auth.token.email == get(/databases/$(database)/documents/config/admin_user).data.email;
    }

    // Regras para a coleção 'users'
    match /users/{userId} {
      // Permite que o admin liste, leia e escreva qualquer perfil de usuário.
      // Um usuário normal só pode ler e escrever seus próprios dados.
      allow list, read, write: if isAdmin() || request.auth.uid == userId;
    }

    // Regras para a coleção 'config'
    match /config/{docId} {
      // O admin pode ler e escrever em qualquer documento de configuração.
      // Usuários normais autenticados só podem ler.
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
